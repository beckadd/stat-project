---
title: "An Analysis of African Systemic Crises"
author: "Beck Addison, Jerry Lin, Isabella Swigart, Emma Hirschkop"
date: "12/3/2019"
output: 
  github_document:
    pandoc_args: --webtex
---

```{r load-packages, message = F}

#install.packages(c("infer","countrycode","pracma", "plotly"))
library(infer)
library(tidyverse)
library(countrycode)
library(pracma)
library(broom)
library(knitr)
library(plotly)
```

```{r load-data-and-initialization, message = F, warning = F}
africa <- read_csv("../data/african_crises.csv")
global <- read_csv("../data/global_crisis_data.csv")
gdps <- read_csv("../data/world_gdp_data.csv")

tests <- 1000

options(scipen = 999)
```

Our analysis begins with two datasets: our original African economic crises dataset, which contains numerical variables like inflation rate, exchange rate against the US dollar, and debt vs. GDP ratio. Another helpful variable to analyze would be each country's GDP, so we downloaded world GDP data from the World Bank, and joined this data with our Africa dataset. We then cleaned up the dataset by renaming some variables and changing their types from integers to booleans.

```{r data-cleaning, warning = F}
gdps <- gdps %>%
  pivot_longer(
    cols = c(
      -`Country Name`,
      -`Country Code`,
      -`Indicator Name`,
      -`Indicator Code`),
    names_to = "year"
  ) %>%
  rename(
    cc3 = `Country Code`,
    indicator_code = `Indicator Code`,
    indicator_name = `Indicator Name`,
    country = `Country Name`,
    gdp = value
    )

african_gdps <- gdps %>%
  merge(., africa, by = c("country","cc3","year"))



african_gdps <- african_gdps %>%
  mutate(
    year = as.numeric(year),
    systemic_crisis = factor(systemic_crisis),
    domestic_debt_in_default = factor(domestic_debt_in_default),
    sovereign_external_debt_default = factor(sovereign_external_debt_default),
    independence = factor(independence),
    currency_crises = factor(case_when(
      currency_crises < 1 ~ 0,
      TRUE ~ 1
    )),
    inflation_crises = factor(inflation_crises),
    banking_crisis = factor(banking_crisis)
  )

global <- global[-1,] %>%
  select(-`<`) %>%
  rename(
    case = Case,
    cc3 = CC3,
    country = Country,
    year = Year,
    banking_crisis = `Banking Crisis`,
    systemic_crisis = `Systemic Crisis`,
    gold_standard = `Gold Standard`,
    nat_currency = `national currency`,
    sov_ext_debt = 
    `SOVEREIGN EXTERNAL DEBT 1: DEFAULT and RESTRUCTURINGS, 1800-2012--Does not include defaults on WWI debt to United States and United Kingdom and post-1975 defaults on Official External Creditors`,
    sov_ext_debt_post1975 = `SOVEREIGN EXTERNAL DEBT 2: DEFAULT and RESTRUCTURINGS, 1800-2012--Does not include defaults on WWI debt to United States and United Kingdom but includes post-1975 defaults on Official External Creditors`,
    exc_primary = `exch_primary source code`,
    domest_debt_default = `Domestic_Debt_In_Default`,
    domest_debt_notes = `Domestic_Debt_ Notes/Sources`,
    default_ext_notes = `Defaults_External_Notes`,
    gdp_weighted_default = `GDP_Weighted_default`,
    inflat_aver_consumer_prices = `Inflation, Annual percentages of average consumer prices`,
    curr_crises = `Currency Crises`,
    independence = `Independence`,
    inflat_crises = `Inflation Crises`
) %>%
  mutate(
    banking_crisis = as.logical(as.numeric(
      banking_crisis
      )),
    systemic_crisis = as.logical(as.numeric(
      systemic_crisis
    )),
    gold_standard = as.logical(as.numeric(
      gold_standard
    )),
    domest_debt_default = as.logical(as.numeric(
      domest_debt_default
    )),
    independence = as.logical(as.numeric(
      independence
    )),
    curr_crises = as.logical(as.numeric(
      curr_crises
    )),
    inflat_crises = as.logical(as.numeric(
      inflat_crises
    ))
  )
```

## Question 1: Hypothesis Testing

#### Was an economic crisis more likely following n years after decolonization?
As African countries made a transition to becoming independent states, many were plagued by violence or political unrest. A bloody 10-year war in Algeria culminated in its independence; lengthy wars were fought in Angola and Mozambique, sectional divides fraught the Congo, and a political revolt ocurred in Kenya. Many of these movements brought economic instability to their countries. However, at the same time, these independence movements were fought in the hopes that establishing an independent nation would bring greater economic prosperity and stability to their country. 

Thus, on a broad level, we'd like to determine how these independence movements ultimately affected the stability of their countries' economies.  

Let's first do some exploratory data anlysis. For each country, let's ask: how many years after independence will a country typically experience its next crisis?

```{r independence}
output <- tibble(country = distinct(africa, country)$country)
output$independence_year <- africa %>%
  filter(independence == 1) %>%
  group_by(country) %>%
  filter(row_number()==1) %>%
  ungroup() %>%
  select(year)
  
output$crisis_year <- africa %>%
  filter(independence == 1) %>%
  group_by(country) %>%
  filter(banking_crisis == "crisis") %>%
  filter(row_number() == 1) %>%
  ungroup() %>%
  select(year)
output <- output %>%
  mutate(difference = (crisis_year$year - independence_year$year))
ggplot(data = output, mapping = aes(y = difference)) +
  geom_boxplot() + 
  labs(
    title = "What's the typical amount of years between a country 
    achieving independence and its next financial crisis?",
    y = "Number of Years")
output %>%
  summarise(IQR = IQR(difference), median = median(difference), mean = mean(difference))
```
We see that the median amount of years a country will first encounter a banking crisis after they achieve independence is about 30 years, with an interquartile range of 11 years and a mean of 31.3 years.

This is fascinating, but we're more interested in seeing if there's a difference in the economic stability of independent vs. colonized African countries. In particular, we're wondering if post-independence African countries see a higher proportion of systemic crises (per year) compared to before independence, when they were colonized. Let's examine it: 

```{r prop-crisis}
africa %>%
  group_by(country, independence) %>%
  summarise(crisis_prop = sum(systemic_crisis)/n())
africa %>%
  group_by(independence) %>%
  summarise(overall_crisis_prop = sum(systemic_crisis)/n())
```

Based on our sample, we see that on average, there is a 0.42% chance of a systemic crisis occurring in any given year for a non-independent (i.e. colonized) country, while there is a 9.85% chance of a systemic crisis occurring in any given year for an independent country. The difference in these proportions is 0.094320737. 

We'd like to conduct a hypothesis test to see if there is a significant difference in the proportion of years with systemic crises between all African countries post-independence and pre-independence. Our null hypothesis is that the proportion of years with systemic crises between African countries post-independence and pre-independence is the same; the observed difference is due to chance. Our alternative hypothesis is that the proportion of years with systemic crises between African countries pre-independence and post-independence is different. 

Since we're testing for independence, we'll use permutation. We'll modify our dataset slightly by factoring success into a categorical variable so that it'll work nicely with infer. We also need to quickly factor systemic_crisis to be a categorical variable:

```{r systemic-categorical}
fct_africa <- africa %>%
  mutate(systemic_crisis = factor(systemic_crisis)) %>%
  mutate(independence = factor(independence))
```

```{r crisis-prop-diff}
set.seed(1)
null_dist <- fct_africa %>%
  specify(response = systemic_crisis, explanatory = independence, 
          success = "1") %>%
  hypothesize(null = "independence") %>%
  generate(tests, type = "permute") %>%
  calculate(stat = "diff in props", 
            order = c("1", "0"))
get_p_value(null_dist, obs_stat = 0.094320737, direction = "both")
visualize(null_dist) +
  shade_p_value(0.094320737, "both") +
  labs(title = "Null Distribution of Difference in Systemic Crisis Proportions", subtitle = "Between Independent and Non-Independent African Countries", x = "Difference in Proportions", 
       y = "Count")
```

Since our p-value of 0 is less than our significance level of 0.05, we reject the null hypothesis. The data provides convincing evidence that there is a difference in the proportion of years with systemic crises between African countries post-independence and pre-independence. 

Ultimately, we can conclude that after gaining independence, African countries experience greater economic instability compared to when they were under colonial rule.

## Question 2: Hypothesis Testing

#### Is there a difference between GDP and systemic crises in North African and sub-Saharan African countries?

Today, many newspapers, academics, and policymakers classify Africa into two broad regions. There's North Africa, consisting of nations like Algeria and Morocco, and sub-Saharan Africa, which conists of countries ranging from the Central African Republic to Botswana. Traditionally, people associate sub-Saharan Africa with being less developed and more impoverished compared to the rest of the continent. In recent years, reports by the World Bank have claimed that more and more of the world's poor are being concentrated into a few sub-Saharan countries.

We set out to see if this is claim is true; that is, if there's a noticeable difference in economic stability and prosperity between North African and sub-Saharan African countries. We can evaluate these claims in two ways: by analyzing our data on each country's GDP and the proportion of years with systemic crises for each country.

To answer this question, we need to label North African and sub-Saharan countries in our Africa dataset. 

``` {r label-region}
fct_africa <- fct_africa %>%
  mutate(region = case_when(
    country == "Algeria" ~ "n",
    country == "Angola" ~ "s",
    country == "Central African Republic" ~ "s",
    country == "Egypt" ~ "n",
    country == "Ivory Coast" ~ "s",
    country == "Kenya" ~ "s",
    country == "Mauritius" ~ "s",
    country == "Morocco" ~ "n",
    country == "Nigeria" ~ "s",
    country == "South Africa" ~ "s",
    country == "Tunisia" ~ "n",
    country == "Zambia" ~ "s",
    country == "Zimbabwe" ~ "s"
  ))
africa <- africa %>%
  mutate(region = case_when(
    country == "Algeria" ~ "n",
    country == "Angola" ~ "s",
    country == "Central African Republic" ~ "s",
    country == "Egypt" ~ "n",
    country == "Ivory Coast" ~ "s",
    country == "Kenya" ~ "s",
    country == "Mauritius" ~ "s",
    country == "Morocco" ~ "n",
    country == "Nigeria" ~ "s",
    country == "South Africa" ~ "s",
    country == "Tunisia" ~ "n",
    country == "Zambia" ~ "s",
    country == "Zimbabwe" ~ "s"
  ))
african_gdps <- african_gdps %>%
  mutate(region = case_when(
    country == "Algeria" ~ "n",
    country == "Angola" ~ "s",
    country == "Central African Republic" ~ "s",
    country == "Egypt" ~ "n",
    country == "Ivory Coast" ~ "s",
    country == "Kenya" ~ "s",
    country == "Mauritius" ~ "s",
    country == "Morocco" ~ "n",
    country == "Nigeria" ~ "s",
    country == "South Africa" ~ "s",
    country == "Tunisia" ~ "n",
    country == "Zambia" ~ "s",
    country == "Zimbabwe" ~ "s"
  ))
```

Let's calculate the median GDP for North African and sub-Saharan countries.

When calculating GDP by region, we'll use 2013 GDP data since it's recent and available for 11 of the 13 African countries in our dataset. We can also perform some exploratory data analysis by visualising sample median GDP.

```{r GDP-region-split, warning = F}
regional_med_gdps <- african_gdps %>%
  filter(year == 2013) %>%
  group_by(region) %>%
  summarise(med_gdp = median(gdp))

regional_med_gdps

rmg <- regional_med_gdps %>%
  pull(med_gdp)

african_gdps_2013 <- african_gdps %>%
  filter(year == 2013)

ggplot(data = african_gdps_2013, mapping = aes(x = region, y = gdp)) +
  geom_boxplot() +
  labs(title = "Median 2013 GDP by Region", x = "Region", y = "Median GDP ($)")
```

The IQR for sub-Saharan countries is much larger than the IQR for North African countries, demonstrating larger variability. The country with the greatest GDP is a sub-Saharan country, which is an outlier for its region. However, the median 2014 GDP for sub-Saharan countries is less than North African countries.

The median GDP for North African countries is `r rmg[1]`; the median GDP for sub-Saharan countries is `r rmg[2]`. Therefore, the difference in median GDP between North African and sub-Saharan countries is `r abs(rmg[1] - rmg[2])`.

The first research question we'll ask is: is there a difference in median GDP among all North African and sub-Saharan countries?

Our null hypothesis is that the median GDP of North African and sub-Saharan countries is the same; the observed difference is due to chance. Our alternative hypothesis is that the median GDP of North African and sub-Saharan African countries is different. 

Since we're testing for independence, we'll use permute.
```{r gdp-prop-diff}
set.seed(1)
gdp_2013 <- african_gdps %>%
  filter(year == 2013)

null_dist2 <- gdp_2013 %>%
  specify(response = gdp, explanatory = region) %>%
  hypothesize(null = "independence") %>%
  generate(tests, type = "permute") %>%
  calculate(stat = "diff in medians", 
            order = c("n", "s"))
get_p_value(null_dist2, obs_stat = rmg[1] - rmg[2], direction = "two_sided")
visualize(null_dist2) +
  shade_p_value(65254905755, "both") +
  labs(title = "Null Distribution of Difference in 2013 Median GDP", subtitle = "Between North African and Sub-Saharan Countries", x = "Difference in GDP ($)", 
       y = "Count")
```

Since our p-value of 0.678 is greater than our significance level of 0.05, we fail to reject the null hypothesis. The data does not provide convincing evidence that there is a significant difference between the median 2013 GDP of North African countries comapred to sub-Saharan countries.

Next, let's calculate the proportion of years with systemic crises for North African and sub-Saharan countries. 

```{r systemic-crisis-by-region}
africa %>%
  group_by(region) %>%
  summarise(overall_crisis_prop = sum(systemic_crisis)/n())
```

The proportion of years with systemic crises for North African countries is 0.0436; the proportion of years with systemic crises for sub-Saharan countries is 0.0971. The difference is 0.0535702.

The second research question we'll ask is: is there a difference in the proportion of years with systemic crises between all North African and sub-Saharan countries?

Our null hypothesis is that the proportion of years with systemic crises between North African and sub-Saharan countries is the same; the observed difference is due to chance. Our alternative hypothesis is that the proportion of years with systemic crises between North African and sub-Saharan countries is different. 

Since we're testing for independence, we'll use permute.
```{r region-prop-diff}
set.seed(1)
null_dist3 <- fct_africa %>%
  specify(response = systemic_crisis, explanatory = region, success = "1") %>%
  hypothesize(null = "independence") %>%
  generate(tests, type = "permute") %>%
  calculate(stat = "diff in props", 
            order = c("n", "s"))
get_p_value(null_dist3, obs_stat = 0.0535702, direction = "two_sided")
visualize(null_dist3) +
  shade_p_value(0.0535702, "both") +
  labs(title = "Null Distribution of Difference in Proportion of Systemic 
  Crises", subtitle = "Between North African and Sub-Saharan Countries", x = "Difference in Proportion", y = "Count")
```

Since our p-value of 0 is less than the significance level of 0.05, we reject the null hypothesis. The data provides convincing evidence that there is a difference in the proportion of years with systemic crises between North African countries and sub-Saharan countries.

From our results, we can conclude that historically — when accounting for all years from the 19th century to today — sub-Saharan African countries have been more prone to systemic crises than North African countries. Yet we failed to find a difference in the 2014 GDP between North African countries and sub-Saharan African countries. That's a positive sign, because it shows that even though there have been historical disparities, in the 21st century, sub-Saharan Africa is catching up, if not meeting, to the economies of North Africa.

## Question 3: Fitting a linear regression model

Finally, we want to see what factors influence a country's GDP the most, as we want to by extension understand what factors most strongly predict economic crises in Africa. Since we cannot (currently) use a binary factor such as `systemic crisis` to determine whether an economy is in crisis or not, we will define "crisis" in terms of GDP growth. If year-on-year GDP growth is negative, we can say that the economy is either recessing or in crisis; for the sake of this examination, we will take both of these to indicate crisis. There is past evidence to show that negative GDP growth is indicative of a crisis, as the 2008 recession saw widespread GDP stagnation or decline. Therefore, we will optimize our model to increase "negative GDP growth". 

First and foremost, we will perform some exploratory data analysis on the change in GDP of African countries in the decade between 2003 and 2013.

```{r gpd-change}
african_gdps_03131 <- african_gdps %>%
  filter(year >= 2003 & year <= 2013) %>%
  filter(country %in% c("Algeria", "Angola", "Central African Republic", "Kenya"))

african_gdps_03132 <- african_gdps %>%
  filter(year >= 2003 & year <= 2013) %>%
  filter(country %in% c("Mauritius", "Morrocco", "South Africa", "Tunisia", "Zambia", "Zimbabwe"))

ggplot(data = african_gdps_03131, mapping = aes(x = year, y = gdp)) +
  facet_grid(. ~ country) +
  geom_line() +
  labs(title = "Change in GDP from 2003-2013", x = "Year", y = "Change in GDP ($)") +
  theme(axis.text.x = element_blank())

ggplot(data = african_gdps_03132, mapping = aes(x = year, y = gdp)) +
  facet_grid(. ~ country) +
  geom_line() +
  labs(title = "Change in GDP from 2003-2013", x = "Year", y = "Change in GDP ($)") +
  theme(axis.text.x = element_blank()) 
```

Next, we must find the difference in GDP growth between every year in the dataset, for each country.

```{r derivative-country-GDPs}

african_gdps <- african_gdps %>%
  group_by(country) %>%
  mutate(
    deltagdp = gdp - lag(gdp, default = gdp[1])
  ) %>%
  mutate(
    neg_deltagdp = -deltagdp
    ) %>%
  select(-deltagdp)

```

Notice that the gdpdelta has been negated - for our model, we want to optimize for an increasingly negative delta GDP, which indicates decline.

Before we perform a backwards step to see which factors are most influential in an increasingly negative delta GDP, we have our "full" model, with all of the variables. Additionally, we have examined the interaction between the `crisis` variables, and the interaction between sovereign and domestic debt in default.

```{r full-model}

full_neg_deltaGDP_model <- lm(
  neg_deltagdp ~ 
    year +
    gdp +
    systemic_crisis +
    exch_usd +
    domestic_debt_in_default +
    sovereign_external_debt_default +
    gdp_weighted_default +
    inflation_annual_cpi +
    independence +
    currency_crises +
    inflation_crises +
    banking_crisis +
    banking_crisis*inflation_crises*currency_crises*systemic_crisis +
    domestic_debt_in_default*sovereign_external_debt_default,
  filter(african_gdps, !is.na(neg_deltagdp))
    )
```

Now we can perform our backwards step function, optimizing for a lower value for AIC.

```{r step-func-AIC, results = "hide"}

best_aic <- step(full_neg_deltaGDP_model, direction = "backward")
```

```{r final-model}
glance(best_aic)

tidy(best_aic) %>%
  select(term, estimate) %>%
  kable(format = "markdown", digits = 3)
```

Now, we are going to calculate the r-squared value. We are going to be using the adjusted r-squared value because this is a multiple regression.

``` {r r-value-best-aic-model}
glance(best_aic)$adj.r.squared

glance(best_aic)$p.value
```

As calculated above, the adjusted R squared value is 0.3174919; since the p-value of this model according to the Central Limit Theorem is much less than 0.05 at $1.79 \times 10^{-43}$ (in effect, p = 0), we can safely conclude that this model shows a statistically significant positive correlation between an African country's negative change in GDP and the country's debt-to-GDP ratio and the presence of either a currency or inflation crisis. To ensure that this model is, in fact, able to be inferred upon, we will also confirm that the model fits the four criteria required for inference for regression:

#### Are observations independent?

Note - this code has been borrowed from the following slide and modified for the purposes of this assignment: https://www2.stat.duke.edu/courses/Fall19/sta199.001/slides/lec-slides/11d-inf-reg.html#40

```{r obs-indep-test}
best_aic_aug <- augment(best_aic)
ggplot(data = best_aic_aug, aes(x = 1:nrow(best_aic_aug), y = .resid)) +
  geom_point() +
  labs(x = "Index", y = "Residual")
```

While it may not at first be evident that these points are independent, this is in large part due to the immense y-axis. Zooming in closer to zero, we can see a more random-looking spread.

```{r obs-indep-test-zoom, warning = F}
best_aic_aug <- augment(best_aic)
ggplot(data = best_aic_aug, aes(x = 1:nrow(best_aic_aug), y = .resid)) +
  geom_point() +
  labs(x = "Index", y = "Residual") +
  ylim(-50000000000/8, 50000000000/8)
```

As we can now see more clearly, the spread indicates that there is no trend that would imply dependence between residuals.

#### Are residuals randomly distributed, and are they constantly variant?

(Again, this code has been borrowed from the lecture slides)

```{r dist-and-variance-resids}
ggplot(data = best_aic_aug, aes(x = .fitted, y = .resid)) +
  geom_point() +
  geom_hline(yintercept = 0, lty = 3, color = "gray") +
  labs(y = "Residuals", x = "Predicted values, y-hat")
```

!!!!! How do we interpret this spread?

#### Are residuals normally distributed around 0?

(Again, this code has been borrowed from the lecture slides)

```{r resids-normal-dist}
ggplot(data = best_aic_aug, aes(x = .resid)) +
  geom_histogram(bins = 75) +
  labs(x = "Residuals")
```

As we can see, the residuals are in fact distributed around 0 with a distribution that can be described as being approximately normal.
